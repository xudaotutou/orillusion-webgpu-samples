import"./modulepreload-polyfill.b7f2da20.js";import{b as G}from"./basic.vert.9475eb7d.js";import{i as U}from"./imageTexture.frag.b24f2b53.js";import{v as P,a as B}from"./cube.aa091a3d.js";import{b as C}from"./math.cb05c6db.js";async function S(e){if(!navigator.gpu)throw new Error("Not Support WebGPU");const t=await navigator.gpu.requestAdapter();if(!t)throw new Error("No Adapter Found");const o=await t.requestDevice(),n=e.getContext("webgpu"),s=navigator.gpu.getPreferredCanvasFormat?navigator.gpu.getPreferredCanvasFormat():n.getPreferredFormat(t),a=window.devicePixelRatio||1;e.width=e.clientWidth*a,e.height=e.clientHeight*a;const r={width:e.width,height:e.height};return n.configure({device:o,format:s,alphaMode:"opaque"}),{device:o,context:n,format:s,size:r}}async function R(e,t,o){const n=await e.createRenderPipelineAsync({label:"Basic Pipline",layout:"auto",vertex:{module:e.createShaderModule({code:G}),entryPoint:"main",buffers:[{arrayStride:20,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:12,format:"float32x2"}]}]},fragment:{module:e.createShaderModule({code:U}),entryPoint:"main",targets:[{format:t}]},primitive:{topology:"triangle-list",cullMode:"back",frontFace:"ccw"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus"}}),s=e.createTexture({size:o,format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT}),a=s.createView(),r=e.createBuffer({label:"GPUBuffer store vertex",size:P.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST});e.queue.writeBuffer(r,0,P);const c=e.createBuffer({label:"GPUBuffer store 4x4 matrix",size:4*4*4,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),f=e.createBindGroup({label:"Uniform Group with Matrix",layout:n.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:c}}]});return{pipeline:n,vertexBuffer:r,mvpBuffer:c,uniformGroup:f,depthTexture:s,depthView:a}}function M(e,t,o,n){const s=e.createCommandEncoder(),a={colorAttachments:[{view:t.getCurrentTexture().createView(),clearValue:{r:0,g:0,b:0,a:1},loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:o.depthView,depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}},r=s.beginRenderPass(a);r.setPipeline(o.pipeline),r.setBindGroup(0,o.uniformGroup),r.setBindGroup(1,n),r.setVertexBuffer(0,o.vertexBuffer),r.draw(B),r.end(),e.queue.submit([s.finish()])}async function A(){const e=document.querySelector("canvas#webgpu"),t=document.querySelector("canvas#canvas");if(!e||!t)throw new Error("No Canvas");const{device:o,context:n,format:s,size:a}=await S(e),r=await R(o,s,a),c=[t.width,t.height],f=o.createTexture({size:c,format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT}),E=o.createSampler({magFilter:"linear",minFilter:"linear"}),v=o.createBindGroup({label:"Texture Group with Texture/Sampler",layout:r.pipeline.getBindGroupLayout(1),entries:[{binding:0,resource:E},{binding:1,resource:f.createView()}]});let m=a.width/a.height;const b={x:0,y:0,z:-5},y={x:1,y:1,z:1},p={x:0,y:0,z:0};function x(){const i=Date.now()/1e3;p.x=Math.sin(i),p.y=Math.cos(i);const u=C(m,b,p,y);o.queue.writeBuffer(r.mvpBuffer,0,u.buffer),o.queue.copyExternalImageToTexture({source:t},{texture:f},c),M(o,n,r,v),requestAnimationFrame(x)}requestAnimationFrame(x),window.addEventListener("resize",()=>{a.width=e.width=e.clientWidth*devicePixelRatio,a.height=e.height=e.clientHeight*devicePixelRatio,r.depthTexture.destroy(),r.depthTexture=o.createTexture({size:a,format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT}),r.depthView=r.depthTexture.createView(),m=a.width/a.height});{const i=t.getContext("2d");if(!i)throw new Error("No support 2d");i.fillStyle="#fff",i.lineWidth=5,i.lineCap="round",i.lineJoin="round",i.fillRect(0,0,t.width,t.height);let u=!1,h=0,g=0,l=0;t.addEventListener("pointerdown",d=>{u=!0,h=d.offsetX,g=d.offsetY}),t.addEventListener("pointermove",d=>{if(!u)return;const w=d.offsetX,T=d.offsetY;l=l>360?0:l+1,i.strokeStyle=`hsl(${l}, 90%, 50%)`,i.beginPath(),i.moveTo(h,g),i.lineTo(w,T),i.stroke(),h=w,g=T}),t.addEventListener("pointerup",()=>u=!1),t.addEventListener("pointerout",()=>u=!1)}}A();
