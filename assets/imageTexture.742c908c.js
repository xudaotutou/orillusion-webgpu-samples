import"./modulepreload-polyfill.b7f2da20.js";import{b}from"./basic.vert.9475eb7d.js";import{i as U}from"./imageTexture.frag.b24f2b53.js";import{v as g,a as G}from"./cube.aa091a3d.js";import{b as B}from"./math.cb05c6db.js";var E="/orillusion-webgpu-samples/texture.webp";async function y(e){if(!navigator.gpu)throw new Error("Not Support WebGPU");const r=await navigator.gpu.requestAdapter();if(!r)throw new Error("No Adapter Found");const i=await r.requestDevice(),n=e.getContext("webgpu"),t=navigator.gpu.getPreferredCanvasFormat?navigator.gpu.getPreferredCanvasFormat():n.getPreferredFormat(r),a=window.devicePixelRatio||1;e.width=e.clientWidth*a,e.height=e.clientHeight*a;const o={width:e.width,height:e.height};return n.configure({device:i,format:t,alphaMode:"opaque"}),{device:i,context:n,format:t,size:o}}async function v(e,r,i){const n=await e.createRenderPipelineAsync({label:"Basic Pipline",layout:"auto",vertex:{module:e.createShaderModule({code:b}),entryPoint:"main",buffers:[{arrayStride:20,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:12,format:"float32x2"}]}]},fragment:{module:e.createShaderModule({code:U}),entryPoint:"main",targets:[{format:r}]},primitive:{topology:"triangle-list",cullMode:"back",frontFace:"ccw"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus"}}),t=e.createTexture({size:i,format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT}),a=t.createView(),o=e.createBuffer({label:"GPUBuffer store vertex",size:g.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST});e.queue.writeBuffer(o,0,g);const s=e.createBuffer({label:"GPUBuffer store 4x4 matrix",size:4*4*4,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),u=e.createBindGroup({label:"Uniform Group with Matrix",layout:n.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:s}}]});return{pipeline:n,vertexBuffer:o,mvpBuffer:s,uniformGroup:u,depthTexture:t,depthView:a}}function C(e,r,i,n){const t=e.createCommandEncoder(),a={colorAttachments:[{view:r.getCurrentTexture().createView(),clearValue:{r:0,g:0,b:0,a:1},loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:i.depthView,depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}},o=t.beginRenderPass(a);o.setPipeline(i.pipeline),o.setBindGroup(0,i.uniformGroup),o.setBindGroup(1,n),o.setVertexBuffer(0,i.vertexBuffer),o.draw(G),o.end(),e.queue.submit([t.finish()])}async function R(){const e=document.querySelector("canvas");if(!e)throw new Error("No Canvas");const{device:r,context:i,format:n,size:t}=await y(e),a=await v(r,n,t),s=await(await fetch(E)).blob(),u=await createImageBitmap(s),p=[u.width,u.height],d=r.createTexture({size:p,format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT});r.queue.copyExternalImageToTexture({source:u},{texture:d},p);const m=r.createSampler({magFilter:"linear",minFilter:"linear"}),x=r.createBindGroup({label:"Texture Group with Texture/Sampler",layout:a.pipeline.getBindGroupLayout(1),entries:[{binding:0,resource:m},{binding:1,resource:d.createView()}]});let f=t.width/t.height;const w={x:0,y:0,z:-5},T={x:1,y:1,z:1},c={x:0,y:0,z:0};function l(){const h=Date.now()/1e3;c.x=Math.sin(h),c.y=Math.cos(h);const P=B(f,w,c,T);r.queue.writeBuffer(a.mvpBuffer,0,P.buffer),C(r,i,a,x),requestAnimationFrame(l)}l(),window.addEventListener("resize",()=>{t.width=e.width=e.clientWidth*devicePixelRatio,t.height=e.height=e.clientHeight*devicePixelRatio,a.depthTexture.destroy(),a.depthTexture=r.createTexture({size:t,format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT}),a.depthView=a.depthTexture.createView(),f=t.width/t.height})}R();
